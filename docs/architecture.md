# 🏮 Kad Kong Ta Smart Insight - Architecture

## ภาพรวมสถาปัตยกรรม (System Architecture)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           External Data Sources                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐ │
│  │  IOC/Pyramid    │  │  OpenWeatherMap │  │  Camera Analytics (Future)  │ │
│  │  Platform       │  │  API            │  │  AI Vision                  │ │
│  ├─────────────────┤  ├─────────────────┤  ├─────────────────────────────┤ │
│  │ • Device List   │  │ • Weather       │  │ • People Count              │ │
│  │ • CCTV Uptime   │  │ • Air Quality   │  │ • Vehicle Count             │ │
│  │ • Sensor Data   │  │ • PM2.5/AQI     │  │ • Density Analysis          │ │
│  └────────┬────────┘  └────────┬────────┘  └──────────────┬──────────────┘ │
│           │                    │                          │                 │
└───────────┼────────────────────┼──────────────────────────┼─────────────────┘
            │                    │                          │
            ▼                    ▼                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                     Backend - Kad Kong Ta Smart Insight                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Data Fusion Service                             │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌───────────────┐  │   │
│  │  │ Pyramid     │ │ Weather     │ │ Camera      │ │ Unified Data  │  │   │
│  │  │ Service     │ │ Service     │ │ Service     │ │ Model         │  │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └───────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Alert Engine                                  │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌───────────────┐  │   │
│  │  │ Crowd       │ │ CCTV        │ │ Weather     │ │ Combined      │  │   │
│  │  │ Density     │ │ Offline     │ │ PM2.5       │ │ Alerts        │  │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └───────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│          ┌─────────────────────────┼─────────────────────────┐             │
│          ▼                         ▼                         ▼             │
│  ┌───────────────┐     ┌───────────────────┐     ┌───────────────────┐    │
│  │   SQLite DB   │     │   SSE Manager     │     │   LINE Service    │    │
│  │  (kadkongta)  │     │   (Real-time)     │     │   (Notifications) │    │
│  └───────────────┘     └───────────────────┘     └───────────────────┘    │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                              REST API Layer                                  │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐  │
│  │ /zones  │ │/alerts  │ │/parking │ │  /pa    │ │/reroute │ │/dashboard│  │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
            │                         │                         │
            ▼                         ▼                         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Client Applications                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌───────────────────┐   │
│  │   Website Platform  │  │   LINE Official     │  │   Mobile App      │   │
│  │   (React Dashboard) │  │   Account           │  │   (Future)        │   │
│  ├─────────────────────┤  ├─────────────────────┤  ├───────────────────┤   │
│  │ • สถานการณ์พื้นที่   │  │ • แจ้งเตือน Real-time│  │ • ผู้ใช้ทั่วไป     │   │
│  │ • แจ้งเตือน         │  │ • สั่งการ (PA/Reroute)│ │ • แผนที่/นำทาง    │   │
│  │ • แจ้งซ่อม          │  │ • สรุปข้อมูลวันนี้   │  │ • ที่จอดรถ        │   │
│  │ • ที่จอดรถ          │  │ • แจ้งซ่อม          │  │                   │   │
│  │ • สรุปข้อมูล        │  │ • Quick Reply Menu  │  │                   │   │
│  └─────────────────────┘  └─────────────────────┘  └───────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## โครงสร้างโซน (Zone Structure)

```
┌─────────────────────────────────────────────────────────────┐
│                    กาดก้องตา ลำปาง                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              MAIN ZONE (ถนนคนเดิน)                   │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐             │   │
│  │  │ Zone A  │  │ Zone B  │  │ Zone C  │             │   │
│  │  │ ทางเข้า  │──│ ตลาดกลาง │──│โซนอาหาร │             │   │
│  │  │ หลัก    │  │         │  │         │             │   │
│  │  │ 500 คน  │  │ 800 คน  │  │ 600 คน  │             │   │
│  │  └─────────┘  └─────────┘  └─────────┘             │   │
│  │                                                     │   │
│  │  📊 ใช้สำหรับ: วิเคราะห์คน, ความหนาแน่น, ความปลอดภัย  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              PARKING ZONE (ที่จอดรถ)                 │   │
│  │  ┌───────────────────┐  ┌───────────────────┐      │   │
│  │  │   Parking P1      │  │   Parking P2      │      │   │
│  │  │   ฝั่งเหนือ        │  │   ฝั่งใต้         │      │   │
│  │  │   150 ช่อง        │  │   200 ช่อง        │      │   │
│  │  └───────────────────┘  └───────────────────┘      │   │
│  │                                                     │   │
│  │  🅿️ ใช้สำหรับ: ข้อมูลที่จอดรถเท่านั้น               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## Data Flow - การไหลของข้อมูล

### 1. ดึงข้อมูลจาก External APIs

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  Pyramid/IOC │     │ OpenWeather  │     │   Camera     │
│  API         │     │ API          │     │   Analytics  │
└──────┬───────┘     └──────┬───────┘     └──────┬───────┘
       │                    │                    │
       │ GET /device        │ GET /weather       │ Analytics
       │ GET /uptimekuma    │ GET /air_pollution │ Data
       │                    │                    │
       ▼                    ▼                    ▼
┌─────────────────────────────────────────────────────────┐
│                 Data Fusion Service                      │
│  • Normalize Data                                        │
│  • Cache Management                                      │
│  • Error Handling                                        │
└──────────────────────────┬──────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                 Unified Data Model                       │
│  {                                                       │
│    zones: { main: [...], parking: [...] },              │
│    devices: { total, online, offline, cctv },           │
│    weather: { temp, humidity, rain, alerts },           │
│    air_quality: { aqi, pm25, pm10 },                    │
│    recent_alerts: [...]                                  │
│  }                                                       │
└─────────────────────────────────────────────────────────┘
```

### 2. Alert Engine - Logic การแจ้งเตือน

```
┌─────────────────────────────────────────────────────────┐
│                    Alert Rules                           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ Rule 1: กล้องเสีย                                │   │
│  │ IF CCTV.status == OFFLINE                        │   │
│  │ THEN                                             │   │
│  │   → สร้าง Alert (level: high)                    │   │
│  │   → สร้าง Incident อัตโนมัติ (แจ้งซ่อม)          │   │
│  │   → ส่ง LINE แจ้งเจ้าหน้าที่                     │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ Rule 2: ฝนตก + คนเยอะ                           │   │
│  │ IF Weather == RAIN                               │   │
│  │ AND Zone.density >= HIGH                         │   │
│  │ THEN                                             │   │
│  │   → สร้าง Alert (level: warning)                 │   │
│  │   → แจ้งเตือน "เสี่ยงถนนลื่น"                    │   │
│  │   → แนะนำเปลี่ยนเส้นทาง                         │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ Rule 3: PM2.5 สูง                               │   │
│  │ IF PM2.5 > 50                                    │   │
│  │ THEN                                             │   │
│  │   → สร้าง Alert (level: warning/critical)        │   │
│  │   → ส่ง LINE แจ้งเตือนคุณภาพอากาศ               │   │
│  │   → บันทึก Alert Log                            │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ Rule 4: ความหนาแน่นสูง                          │   │
│  │ IF Zone.density >= 80%                           │   │
│  │ THEN                                             │   │
│  │   → สร้าง Alert (level: high/critical)          │   │
│  │   → ส่ง LINE แจ้งเตือน                          │   │
│  │   → แนะนำกระจายคน                               │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## API Endpoints Summary

### Main APIs

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/dashboard/summary` | GET | ข้อมูลรวม Dashboard (Unified) |
| `/api/dashboard/unified` | GET | Unified Data Model |
| `/api/zones/main/summary` | GET | สรุปโซน A/B/C |
| `/api/zones/parking/status` | GET | สถานะที่จอดรถ P1/P2 |
| `/api/devices/health` | GET | สถานะอุปกรณ์ทั้งหมด |
| `/api/alerts` | GET/POST | รายการแจ้งเตือน |
| `/api/incidents` | GET/POST | รายการแจ้งซ่อม |
| `/api/pa` | POST | สั่งเสียงตามสาย |
| `/api/reroute` | POST | สั่งเปลี่ยนเส้นทาง |
| `/api/events` | GET (SSE) | Real-time Events |

### LINE Integration

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/line/webhook` | POST | LINE Webhook Handler |
| `/line/push` | POST | Push message to users |
| `/line/broadcast` | POST | Broadcast to all followers |

---

## LINE OA Commands

| คำสั่ง | การทำงาน |
|--------|----------|
| `ที่จอดรถ` | แสดงสถานะที่จอดรถ P1/P2 |
| `สรุปข้อมูลวันนี้` | แสดงสรุปประจำวัน |
| `แจ้งเตือน` | แสดงการแจ้งเตือนที่ยังไม่รับทราบ |
| `แจ้งซ่อม` | ดู/สร้างรายการแจ้งซ่อม |
| `แจ้งซ่อม A [รายละเอียด]` | สร้างการแจ้งซ่อมในโซน A |
| `ประกาศ B [ข้อความ]` | สั่งเสียงตามสายในโซน B (Supervisor) |
| `ช่วยเหลือ` | แสดงคำสั่งทั้งหมด |

---

## Security & Compliance

### Data Governance (PDPA)

- ✅ จัดเก็บเฉพาะข้อมูลเชิงตัวเลข (จำนวนคน, จำนวนรถ)
- ✅ ไม่เก็บภาพจากกล้อง
- ✅ ไม่เก็บข้อมูลส่วนบุคคล
- ✅ บันทึก Log ทุกการกระทำ (Action Logs)
- ✅ จำกัดสิทธิ์ตาม Role (RBAC)

### Role-Based Access Control

| Role | Permissions |
|------|-------------|
| `admin` | ทุกสิทธิ์ |
| `supervisor` | PA, Reroute, Notify, Repair, View, Reports |
| `field_staff` | Repair, View, Notify |

---

## Environment Variables

ดู `.env.example` สำหรับการตั้งค่าทั้งหมด

### Required APIs:
1. **LINE OA** - สำหรับการแจ้งเตือนและสั่งการ
2. **OpenWeatherMap** - สำหรับข้อมูลสภาพอากาศและ PM2.5
3. **Pyramid/IOC** - สำหรับข้อมูลอุปกรณ์และ CCTV Status

---

## Deployment

```bash
# Development
npm run dev

# Production
npm start

# Docker
docker-compose up -d
```

---

## Future Enhancements

1. **Analytics Dashboard** - กราฟวิเคราะห์ข้อมูลย้อนหลัง
2. **AI Camera Integration** - วิเคราะห์ภาพจากกล้อง Real-time
3. **Mobile App** - แอพสำหรับผู้ใช้ทั่วไป
4. **Predictive Analytics** - พยากรณ์ความหนาแน่นล่วงหน้า
5. **Smart Pole Integration** - เชื่อมต่อเสาอัจฉริยะ
